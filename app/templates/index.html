{% extends "base.html" %}

{% block title %}–ù–∞—á–∞–ª–æ - –ú–æ–∏—Ç–µ –ó–∞–¥–∞—á–∏{% endblock %}

{% block content %}
<div class="user-nav">
    <div>
        <span>üëã –ó–¥—Ä–∞–≤–µ–π, <strong>{{ user.username }}</strong>!</span>
        <span class="badge">{{ user.role }}</span>
    </div>
    <div style="display: flex; gap: 15px; align-items: center;">
        {% if user.role == "admin" %}
            <a href="/admin/dashboard" class="edit-link" style="color: var(--danger);">üõ†Ô∏è –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</a>
        {% endif %}
        <a href="/logout" class="nav-link" style="font-weight: bold;">üö™ –ò–∑—Ö–æ–¥</a>
    </div>
</div>

<div class="task-card">
    <h2>üöÄ –ù–æ–≤–∞ –∑–∞–¥–∞—á–∞</h2>
    <div class="form-grid">
        <div class="field-group">
            <label for="title">–ó–∞–≥–ª–∞–≤–∏–µ</label>
            <input type="text" id="title" placeholder="–ö–∞–∫–≤–æ –ø–ª–∞–Ω–∏—Ä–∞—à?">
        </div>

        <div class="field-group">
            <label for="task_type">–¢–∏–ø –∑–∞–¥–∞—á–∞</label>
            <select id="task_type" onchange="toggleTaskFields()">
                <option value="WorkTask">–†–∞–±–æ—Ç–Ω–∞ (Work)</option>
                <option value="PersonalTask">–õ–∏—á–Ω–∞ (Personal)</option>
            </select>
        </div>

        <div class="field-group" id="deadline-group">
            <label for="deadline">–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫</label>
            <input type="date" id="deadline">
        </div>

        <div class="field-group" id="priority-group" style="display: none;">
            <label for="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select id="priority">
                <option value="Low">–ù–∏—Å—ä–∫</option>
                <option value="Medium" selected>–°—Ä–µ–¥–µ–Ω</option>
                <option value="High">–í–∏—Å–æ–∫</option>
            </select>
        </div>

        <button class="btn-primary" onclick="createTask()">–î–æ–±–∞–≤–∏</button>
    </div>
</div>

<div class="tasks-section">
    <h3 style="border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px;">üìã –°–ø–∏—Å—ä–∫ —Å—ä—Å –∑–∞–¥–∞—á–∏</h3>
    <ul class="task-list">
        {% for task in tasks %}
            <li class="task-item">
                <div class="task-info">
                    <strong style="display: block; font-size: 1.1rem;">{{ task.title }}</strong>
                    <small style="color: #64748b;">
                        {% if task.type == 'WorkTask' %}
                            üìÖ –ö—Ä–∞–µ–Ω —Å—Ä–æ–∫: {{ task.deadline or '–ù—è–º–∞' }}
                        {% else %}
                            üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ task.priority or '–ù–æ—Ä–º–∞–ª–µ–Ω' }}
                        {% endif %}
                    </small>
                </div>
                <a href="/edit/{{ task.id }}" class="edit-link">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</a>
            </li>
        {% endfor %}
    </ul>
</div>

{% block scripts %}
<script>
function toggleTaskFields() {
    const type = document.getElementById('task_type').value;
    const deadlineGroup = document.getElementById('deadline-group');
    const priorityGroup = document.getElementById('priority-group');

    if (type === 'WorkTask') {
        deadlineGroup.style.display = 'flex';
        priorityGroup.style.display = 'none';
    } else {
        deadlineGroup.style.display = 'none';
        priorityGroup.style.display = 'flex';
    }
}

async function createTask() {
    const title = document.getElementById('title').value;
    const task_type = document.getElementById('task_type').value;
    const deadline = document.getElementById('deadline').value;
    const priority = document.getElementById('priority').value;

    if (!title) {
        alert("–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –∑–∞–≥–ª–∞–≤–∏–µ!");
        return;
    }

    const taskData = {
        title: title,
        description: "",
        task_type: task_type,
        deadline: task_type === 'WorkTask' ? (deadline || null) : null,
        priority: task_type === 'PersonalTask' ? priority : null
    };

    try {
        const response = await fetch('/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert("–ì—Ä–µ—à–∫–∞: " + (error.detail || "–ù–µ—É—Å–ø–µ—à–Ω–æ —Å—ä–∑–¥–∞–≤–∞–Ω–µ"));
        }
    } catch (err) {
        console.error("–ì—Ä–µ—à–∫–∞:", err);
    }
}
</script>
{% endblock %}
{% endblock %}