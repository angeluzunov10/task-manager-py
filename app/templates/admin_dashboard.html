<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/admin.css') }}">
</head>
<body>

<header>
    <h1>> ADMIN_PANEL_ROOT</h1>
    <div class="status-bar">
        <span>USER: {{ user.username }}</span>
        <span>ROLE: {{ user.role }}</span>
        <span>SYSTEM: ACTIVE</span>
    </div>
    <nav style="margin-top: 20px;">
        <a href="/">[ ВЪРНИ СЕ В СИСТЕМАТА ]</a>
        <a href="/logout">[ ИЗХОД ]</a>
    </nav>
</header>

<div class="container">
    <section>
        <h2>// Списък_Потребители</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ПОТРЕБИТЕЛ</th>
                    <th>РОЛЯ</th>
                    <th>ДЕЙСТВИЕ</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td class="id-badge">#{{ u.id }}</td>
                    <td>{{ u.username }}</td>
                    <td>
                        <form action="/admin/user/{{ u.id }}/role" method="POST">
                            <select name="new_role" onchange="this.form.submit()" {% if u.id == 1 %}disabled{% endif %}>
                                <option value="user" {% if u.role == 'user' %}selected{% endif %}>USER</option>
                                <option value="editor" {% if u.role == 'editor' %}selected{% endif %}>EDITOR</option>
                                <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>ADMIN</option>
                            </select>
                        </form>
                    </td>
                    <td>
                        {% if u.id != 1 %}
                        <form action="/admin/user/{{ u.id }}/delete" method="POST">
                            <button type="submit" class="btn-delete">DELETE_USER</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <section>
        <h2>// Списък_Задачи</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ЗАГЛАВИЕ</th>
                    <th>СЪЗДАДЕНА_НА</th>
                    <th>СЪЗДАТЕЛ</th>
                    <th>КОНТРОЛ</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tasks %}
                <tr>
                    <td class="id-badge">{{ t.id }}</td>
                    <td>{{ t.title }}</td>
                    <td>{{ t.created_at.strftime('%Y-%m-%d %T') if t.created_at else 'N/A' }}</td>
                    <td>{{ t.owner.username if t.owner else 'SYSTEM' }}</td>
                    <td>
                        <button data-id="{{ t.id }}" onclick="deleteTaskFromAdmin(this)" class="btn-delete">WIPE_DATA</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
</div>

<script>
async function deleteTaskFromAdmin(button) {
    const id = button.getAttribute('data-id');
    if(confirm('ПОТВЪРДЕТЕ ИЗТРИВАНЕ НА ОБЕКТ #' + id)) {
        const res = await fetch(`/tasks/${id}`, { method: 'DELETE' });
        if(res.ok) {
            location.reload();
        } else {
            alert('ГРЕШКА: ДОСТЪПЪТ ОТКАЗАН');
        }
    }
}
</script>

</body>
</html>