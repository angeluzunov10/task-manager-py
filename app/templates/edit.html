{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ - {{ task_id }}{% endblock %}

{% block content %}
<div class="container">
    <div class="task-card" style="max-width: 550px; margin: 2rem auto;">
        <h2>üéØ –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∑–∞–¥–∞—á–∞</h2>
        
        <div class="form-vertical">
            <div class="field-group">
                <label>–ó–∞–≥–ª–∞–≤–∏–µ</label>
                <input type="text" id="edit-title" placeholder="–ò–º–µ –Ω–∞ –∑–∞–¥–∞—á–∞—Ç–∞">
            </div>
            
            <div class="field-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="edit-desc" placeholder="–î–æ–±–∞–≤–∏ –¥–µ—Ç–∞–π–ª–∏ —Ç—É–∫..."></textarea>
            </div>

            <div class="field-group" id="edit-deadline-group" style="display: none;">
                <label>–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫</label>
                <input type="date" id="edit-deadline">
            </div>

            <div class="field-group" id="edit-priority-group" style="display: none;">
                <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select id="edit-priority">
                    <option value="Low">–ù–∏—Å—ä–∫</option>
                    <option value="Medium">–°—Ä–µ–¥–µ–Ω</option>
                    <option value="High">–í–∏—Å–æ–∫</option>
                </select>
            </div>

            <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn-primary" onclick="saveTask()">üíæ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
                
                <button class="btn-logout-nav" onclick="deleteTask()" style="width: 100%; height: 45px;">
                    üóëÔ∏è –ò–∑—Ç—Ä–∏–π –∑–∞–¥–∞—á–∞—Ç–∞
                </button>
                
                <a href="/" style="text-align: center; text-decoration: none; color: #64748b; font-size: 0.9rem;">
                    ‚Üê –û—Ç–∫–∞–∑ –∏ –≤—Ä—ä—â–∞–Ω–µ
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    //–í–∑–∏–º–∞–º–µ ID-—Ç–æ, –∫–æ–µ—Ç–æ Python –∏–Ω–∂–µ–∫—Ç–∏—Ä–∞ –≤ HTML-–∞
    const taskId = "{{ task_id }}";
    let currentTaskType = "";

    // window.onload —Å–µ –∏–∑–ø—ä–ª–Ω—è–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –∏ –∫–æ–¥—ä—Ç —Ç—Ä—ä–≥–≤–∞ —Å–∞–º
    window.onload = async function() {
        const response = await fetch(`/tasks/${taskId}`); // –í–∑–µ–º–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ –∑–∞ –∑–∞–¥–∞—á–∞—Ç–∞ —Å—ä—Å —Å—ä–æ—Ç–≤–µ—Ç–Ω–æ—Ç–æ ID –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞
        if (response.ok) { // –ê–∫–æ –≤—Å–∏—á–∫–æ –µ –º–∏–Ω–∞–ª–æ –¥–æ–±—Ä–µ
            const task = await response.json(); // –í–∑–µ–º–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ –Ω–∞ –∑–∞–¥–∞—á–∞—Ç–∞ –∫–∞—Ç–æ JSON
            // –ü–æ–ø—ä–ª–≤–∞–º–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ª–µ—Ç–∞—Ç–∞ - —Ç–æ–≤–∞ –µ "–º–∞–≥–∏—è—Ç–∞", –≤–∑–∏–º–∞–º –¥–∞–Ω–Ω–∏—Ç–µ –∏ –≥–∏ —Å–ª–∞–≥–∞–º –≤ –µ–ª–µ–º–µ–Ω—Ç–∏—Ç–µ —Å—ä—Å —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—Ç–µ ID-—Ç–∞(–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏ –≤ HTML-–∞)
            document.getElementById('edit-title').value = task.title;
            document.getElementById('edit-desc').value = task.description || "";
            currentTaskType = task.type;

            // –ü–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ—Ç–≤–µ—Ç–Ω–æ—Ç–æ –ø–æ–ª–µ —Å–ø–æ—Ä–µ–¥ —Ç–∏–ø–∞
            if (task.type === 'WorkTask') {
                document.getElementById('edit-deadline-group').style.display = 'block';
                document.getElementById('edit-deadline').value = task.deadline || "";
            } else if (task.type === 'PersonalTask') {
                document.getElementById('edit-priority-group').style.display = 'block';
                document.getElementById('edit-priority').value = task.priority || "Medium";
            }
        }
    };

    async function saveTask() { // –§—É–Ω–∫—Ü–∏—è, –∫–æ—è—Ç–æ —Å–µ –≤–∏–∫–∞ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–µ –Ω–∞ –±—É—Ç–æ–Ω–∞ "–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ"
        const title = document.getElementById('edit-title').value; // –í–∑–µ–º–∞–º–µ –Ω–æ–≤–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –æ—Ç –∏–Ω–ø—É—Ç–∏—Ç–µ
        const desc = document.getElementById('edit-desc').value;
        const deadline = document.getElementById('edit-deadline').value;
        const priority = document.getElementById('edit-priority').value;

        const updateData = {
            title: title,
            description: desc,
            deadline: currentTaskType === 'WorkTask' ? deadline : null,
            priority: currentTaskType === 'PersonalTask' ? priority : null
        };

        // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ PUT, –∑–∞—â–æ—Ç–æ –æ–±–Ω–æ–≤—è–≤–∞–º–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â —Ä–µ—Å—É—Ä—Å
        const response = await fetch(`/tasks/${taskId}`, {  // –ü—Ä–∞—â–∞–º–µ UPDATE –∑–∞—è–≤–∫–∞ –∫—ä–º –Ω–∞—à–∏—è /tasks/{task_id} endpoint
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }, // –ö–∞–∑–≤–∞–º–µ, —á–µ –ø—Ä–∞—â–∞–º–µ JSON
            body: JSON.stringify(updateData)// –¢—è–ª–æ—Ç–æ –Ω–∞ –∑–∞—è–≤–∫–∞—Ç–∞ –µ JSON –æ–±–µ–∫—Ç —Å –Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω–∏ –∑–∞ –∑–∞–¥–∞—á–∞—Ç–∞
        });

        if (response.ok) {
            alert("–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ!");
            window.location.href = "/"; // –ü—Ä–µ–Ω–∞—Å–æ—á–≤–∞–Ω–µ (–∫–∞—Ç–æ redirect –≤ Django)
        } else {
            alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ—Ç–æ.");
        }
    }

    async function deleteTask() {
        // 1. –ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (–¥–æ–±—Ä–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞)
        if (!confirm("–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–∞–∑–∏ –∑–∞–¥–∞—á–∞?")) return;

        // 2. –ò–∑–ø—Ä–∞—â–∞–º–µ DELETE –∑–∞—è–≤–∫–∞ –∫—ä–º API-—Ç–æ
        const response = await fetch(`/tasks/${taskId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert("–ó–∞–¥–∞—á–∞—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞ —É—Å–ø–µ—à–Ω–æ!");
            window.location.href = "/"; // –í—Ä—ä—â–∞–º–µ —Å–µ –≤ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        } else {
            alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ.");
        }
    }
</script>
{% endblock %}